#!/bin/sh
# Pre-push hook to optionally prevent direct pushes to main/master branches
# Controlled by ALLOW_DIRECT_PUSH_TO_MAIN environment variable

# Color codes for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get the branch being pushed to
while read local_ref local_sha remote_ref remote_sha
do
    # Extract branch name from ref
    branch=$(echo "$remote_ref" | sed 's/refs\/heads\///')
    
    # Check if pushing to main or master
    if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
        
        # Check environment variable or .env file
        if [ -f .env ]; then
            # Source the .env file to get ALLOW_DIRECT_PUSH_TO_MAIN
            export $(grep -E '^ALLOW_DIRECT_PUSH_TO_MAIN=' .env | xargs)
        fi
        
        # Default to false if not set
        ALLOW_DIRECT_PUSH="${ALLOW_DIRECT_PUSH_TO_MAIN:-false}"
        
        if [ "$ALLOW_DIRECT_PUSH" = "false" ] || [ "$ALLOW_DIRECT_PUSH" = "0" ] || [ "$ALLOW_DIRECT_PUSH" = "no" ]; then
            echo "${RED}❌ Direct push to $branch branch is disabled!${NC}"
            echo ""
            echo "${YELLOW}Branch protection is enabled. Please:${NC}"
            echo "  1. Create a feature branch: ${GREEN}git checkout -b feature/your-feature${NC}"
            echo "  2. Push your branch: ${GREEN}git push origin feature/your-feature${NC}"
            echo "  3. Create a Pull Request on GitHub"
            echo ""
            echo "${YELLOW}To temporarily allow direct pushes (NOT RECOMMENDED):${NC}"
            echo "  - Set ${GREEN}ALLOW_DIRECT_PUSH_TO_MAIN=true${NC} in your .env file"
            echo "  - Or run: ${GREEN}ALLOW_DIRECT_PUSH_TO_MAIN=true git push${NC}"
            echo ""
            exit 1
        else
            echo "${YELLOW}⚠️  Warning: Direct push to $branch branch!${NC}"
            echo "${YELLOW}Branch protection is currently disabled (ALLOW_DIRECT_PUSH_TO_MAIN=$ALLOW_DIRECT_PUSH)${NC}"
            echo "${YELLOW}Consider creating a pull request instead for code review.${NC}"
            echo ""
            
            # Give user a chance to cancel
            echo "Pushing directly to $branch in 3 seconds... Press Ctrl+C to cancel"
            sleep 3
        fi
    fi
done

exit 0